<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Knife</title>
<!-- <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/5.1.3/pixi.min.js"></script> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.8.0/gsap.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r125/three.min.js"></script>
<script type="text/javascript" src="OrbitControls.js"></script>
<script type="text/javascript" src="OBJLoader.js"></script>
<script type="text/javascript" src="MTLLoader.js"></script>

<style type="text/css">
  canvas#knife3d {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }

  .circle {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.6);    
  }

  #circle1 {
    opacity: 0;
  }

  #circle3 {
    opacity: 0;
  }

  #menu {
    position: absolute;
    top: 50%;
    left: 8%;
    transform: translate(-50%, -50%) scale(0.75);
  }

  #name {
    position: absolute;
    top: 10%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.8);
  }

  #zoom_line {
    position: absolute;
    top: 50%;
    left: 90%;    
    transform: translate(-50%, -50%) scale(0.7);
  }

  #pimp {
    cursor: pointer;
    position: absolute;
    top: 50%;
    transform: translate(-50%, -50%);
  }

  #color_bar {    
    position: absolute;
    left: 50%;
    bottom: 5%; 
    transform: translate(-50%, -50%);
  }

  .min_circle {
    padding: 10px;
    cursor: pointer;
  }

  #select_circle {
    position: absolute;
    left: 50%;
    bottom: 5%; 
    transform: translate(-21px, -27px);
    pointer-events: none;
  }
</style>

<script type="text/javascript">
window.onload = async function init() {
  let canvas = document.getElementById("knife3d");
  let render3d = new THREE.WebGLRenderer({alpha:true, antialias:true, canvas}); 
  //render3d.physicallyCorrectLights = true;
  render3d.setSize(1024, 1024);

  let knife;
  let knifeToScale = 10;
  let knifeScale = 0;
  let scene = new THREE.Scene();  

  let camera = new THREE.PerspectiveCamera(45, 1024/1024,);
  camera.position.set(-80,0,0);  
  camera.lookAt(0,0,0);
  scene.add(camera);    

  let point_light = new THREE.PointLight(0xffffff, 0.05, 0, 2);
  point_light.position.set(100, 250, -100);
  point_light.castShadow = true; 
  point_light.shadow.mapSize.set(2048, 2048);
  scene.add(point_light);     

  let abient_light = new THREE.AmbientLight(0xffffff);     
  scene.add(abient_light);  

  const pmremGenerator = new THREE.PMREMGenerator( render3d );
  pmremGenerator.compileEquirectangularShader();

  let controls = new THREE.OrbitControls( camera, render3d.domElement );   

  let mtlLoader = new THREE.MTLLoader();
  mtlLoader.load('assets/obj/knife.mtl', function(materials) {
    materials.preload();

    let objLoader = new THREE.OBJLoader();
    objLoader.setMaterials(materials);
    objLoader.setPath('assets/obj/');
    objLoader.load('knife.obj', async function (obj) { 
      knife = obj;     
      obj.position.set(0,0,-2);      
      scene.add(obj);

      let envMap = await loadTexture('assets/obj/enviroment3.jpg');
      envMap.mapping = THREE.EquirectangularReflectionMapping;
      envMap.encoding = THREE.sRGBEncoding;  

      /*let bumpMap = await loadTexture('assets/obj/SteelRoughness.jpg');
      bumpMap.mapping = THREE.UVMapping;
      bumpMap.encoding = THREE.sRGBEncoding;*/  

      //let normalMap = await loadTexture('assets/obj/SteelNormal.jpg');

      let material1 = new THREE.MeshStandardMaterial({metalness: 1, roughness: 0.3, envMap} ); 
      let material2 = new THREE.MeshStandardMaterial({metalness: 0.9, roughness: 0.0, envMap} ); 
      let material3 = new THREE.MeshStandardMaterial({metalness: 1, roughness: 0.1, envMap} ); 

      /*var material1 = new THREE.MeshPhongMaterial({
          color: 0xffb54a, // ( use 0xffffff if you do not want gold )
          specular: 0x111111, // non-metals do not have high specularity
          //map: THREE.ImageUtils.loadTexture( '173_diffuse.png' ),
          //specularMap: THREE.ImageUtils.loadTexture( '173_specular.png' ),
          normalMap: normalMap,
          envMap: envMap,
          combine: THREE.AddOperation,
          reflectivity: 0.2          
      });*/
      

      knife.children[0].material[0] = material1;
      knife.children[0].material[1] = material2;
      knife.children[0].material[2] = material3;

      knife.children[2].material[1] = material3;
      knife.children[3].material[1] = material3;
      knife.children[4].material[1] = material3;
      knife.children[5].material[1] = material3;

      //console.log(knife.children[0]);

      animate();      
    });
  });

  

  function loadTexture(url) {
    let textureLoader = new THREE.TextureLoader();
    return new Promise(resolve => {
      textureLoader.load('assets/obj/enviroment3.jpg', (texture) => {
        resolve(texture);
      })
    })    
  }

  function animate() {    
    controls.update();    
    render3d.render(scene, camera);
    knifeScale += (knifeToScale - knifeScale)/20;
    knife.scale.set(knifeScale, knifeScale, knifeScale);
    requestAnimationFrame(animate);  
  }  

  let colorBar = [
    document.getElementById("min_circle1"),
    document.getElementById("min_circle2"),
    document.getElementById("min_circle3")
  ]

  let circles = [
    document.getElementById("circle1"),
    document.getElementById("circle2"),
    document.getElementById("circle3")
  ]

  let selectCircle = document.getElementById("select_circle");
  
  colorBar[0].onclick = ()=>{    
    let textureLoader = new THREE.TextureLoader();
    textureLoader.load('assets/texture4.jpg', (texture)=>{      
      knife.children[1].material[1].map = texture;
      hideCircles();
      circles[0].style.opacity = 1;
      knifeScale = 0;
    })
    selectCircle.style = "transform: translate(-67px, -27px);"
  }

  colorBar[1].onclick = ()=>{
    let textureLoader = new THREE.TextureLoader();
    textureLoader.load('assets/texture2.jpg', (texture)=>{      
      knife.children[1].material[1].map = texture;
      hideCircles();
      circles[1].style.opacity = 1;
      knifeScale = 0;
    })
    selectCircle.style = "transform: translate(-21px, -27px);"
  }

  colorBar[2].onclick = ()=>{
    let textureLoader = new THREE.TextureLoader();
    textureLoader.load('assets/texture1.jpg', (texture)=>{      
      knife.children[1].material[1].map = texture;
      hideCircles();
      circles[2].style.opacity = 1;
      knifeScale = 0;
    })
    selectCircle.style = "transform: translate(25px, -27px);"
  }

  function hideCircles() {
    circles.forEach(img => img.style.opacity=0);
  }

  let zoom_line = document.getElementById("zoom_line");
  let pimp = document.getElementById("pimp"); 

  dragElement(pimp);

  function dragElement(elmnt) {    
    elmnt.onmousedown = dragMouseDown;
    elmnt.touchstart = dragMouseDown;

    function dragMouseDown() {         
      document.onmouseup = stopDragElement;      
      document.onmousemove = elementDrag;
      document.touchend = stopDragElement;
      document.touchmove = elementDrag;
    }

    function elementDrag(e) {
      e = e || window.event;
      e.preventDefault();   

      let dy = 219 - (zoom_line.offsetTop - e.clientY)*1.42;
      if (dy < 0) dy = 0;
      if (dy > 433) dy = 433;

      elmnt.style.top = dy + "px";
      knifeToScale = 10 - 8*(0.5-dy/433);      
    }

    function stopDragElement() {      
      document.onmouseup = null;
      document.onmousemove = null;
      document.touchmove = null;
      document.touchend = null;
    }
  }
  
  window.addEventListener('resize', onResize);

  function onResize() {
    if(window.innerHeight > window.innerWidth) {
      let zoom_line = document.getElementById("zoom_line");
      zoom_line.style.left = '50%';
      zoom_line.style.top = '70%';
      zoom_line.style.transform = 'rotate(90deg)';
      let menu = document.getElementById("menu"); 
      menu.style.left = '50%';
      menu.style.top = '5%';
      menu.src = 'assets/menu_portrait.png';
    } else {
      zoom_line.style.left = '90%';
      zoom_line.style.top = '50%';
      zoom_line.style.transform = 'translate(-50%, -50%) scale(0.7)';
      menu.style.left = '10%';
      menu.style.top = '50%';
      menu.src = 'assets/menu.png';
    }
  }

  onResize();  
}
</script>

</head>
<body style="background-color: black;"> 
  <img id="circle1" class="circle" src="assets/circle1.png">
  <img id="circle2" class="circle" src="assets/circle2.png">
  <img id="circle3" class="circle" src="assets/circle3.png">
  <img id="menu" src="assets/menu.png">
   
  <canvas id="knife3d"></canvas>  
  <div id="color_bar">
    <img id="min_circle1" class="min_circle" src="assets/min_circle1.png">
    <img id="min_circle2" class="min_circle" src="assets/min_circle2.png">
    <img id="min_circle3" class="min_circle" src="assets/min_circle3.png">     
  </div>
  <img id="select_circle" src="assets/select_circle.png"> 
   <div id="zoom_line">
    <img id="line" src="assets/line.png">
    <img id="pimp" src="assets/pimp.png">
  </div>  
  <img id="name" src="assets/name.png">  
</body>
</html>