<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>GG-396</title>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/5.1.3/pixi.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.5.1/gsap.min.js"></script>
<script type="text/javascript" src="LEV.js"></script>

<script type="text/javascript">
(function() {
	window.onload = async function init() {
		'use strict'	

		var lev = new LEV(360, 640);

		var stage = lev.app.stage;
		stage.interactive = true;
			
		var layer = {			
			main: lev.container({add:stage}),
			ps: lev.container({add:stage}),
			ui: lev.container({add:stage})
		};		

		lev.app.loader		
		.add('back', 'assets/back.jpg')
		.add('stair', 'assets/stair.png')
		.add('stair1', 'assets/stair1.png')
		.add('stair2', 'assets/stair2.png')
		.add('stair3', 'assets/stair3.png')
		.add('logo', 'assets/logo.png')
		.add('button_continue', 'assets/button_continue.png')		
		.add('button_ok', 'assets/button_ok.png')
		.add('icon_hammer', 'assets/icon_hammer.png')
		.add('icon_stair_back_off', 'assets/icon_stair_back_off.png')
		.add('icon_stair_back_on', 'assets/icon_stair_back_on.png')
		.add('icon_stair1', 'assets/icon_stair1.png')
		.add('icon_stair2', 'assets/icon_stair2.png')
		.add('icon_stair3', 'assets/icon_stair3.png')
		.add('Austin', 'assets/Austin.png')
		.add('book', 'assets/book.png')
		.add('sofa', 'assets/sofa.png')		
		.add('plant1', 'assets/plant1.png')
		.add('plant2', 'assets/plant2.png')
		.add('table', 'assets/table.png')
		.add('packshot', 'assets/packshot.png')
		.load(startGame)
		
		function startGame() {	
			var icons = [];
			var back = lev.sprite('back', {add:layer.main});
			var book = lev.sprite('book', {add:layer.main});
			var table = lev.sprite('table', {add:layer.main});			
			var men = lev.sprite('Austin', {anchor:[0.5,1], add:layer.main});
			var plant2 = lev.sprite('plant2', {add:layer.main});

			var stair = lev.container({add:layer.main});
			var stair0 = lev.sprite('stair', {add:stair});
			var stair1 = lev.sprite('stair1', {alpha:0, add:stair});
			var stair2 = lev.sprite('stair2', {alpha:0, add:stair});
			var stair3 = lev.sprite('stair3', {alpha:0, add:stair});
			var currStair = stair0;

			var icons_stair = lev.container({add:layer.main});
			var icon_hammer = lev.sprite('icon_hammer', {anchor:[0.5,1], x:200, y:285, alpha:0, interactive:true, add:icons_stair});
			icon_hammer.on('tap', hammerTapHandler);			
			makeIconStair('icon_stair1', -25, 215, stair1);
			makeIconStair('icon_stair2', 50, 140, stair2);
			makeIconStair('icon_stair3', 125, 65, stair3);

			var plant1 = lev.sprite('plant1', {add:layer.main});
			var sofa = lev.sprite('sofa', {add:layer.main});

			var logo = lev.sprite('logo', {anchor:0.5, add:layer.ui});
			var button_continue = lev.container({interactive:true, add:layer.ui});
			button_continue.sprite = lev.sprite('button_continue', {anchor:0.5, add:button_continue});
			button_continue.on('tap', adClickHandler);
			
			gsap.to(button_continue.sprite.scale, {x:0.9, y:0.9, duration:1.5, repeat:-1, yoyo:true, ease:'quad.inOut'});
			gsap.to(icon_hammer, {alpha:1, delay:0.5, duration:0.25});
			gsap.from(icon_hammer.scale, {x:0, y:0, delay:0.5, duration:0.75, ease:'elastic.out'});
			gsap.fromTo(icon_hammer, {angle:-5, delay:2}, {angle:0, repeatDelay:2, duration:1.5, repeat:-1, ease:'elastic.out'});

			lev.resize.start({
				portrait: [
					[back, {x:-570, y:0, scale:1}],
					[stair, {x:50, y:95, scale:1}],
					[icons_stair, {x:80, y:65, scale:1}],
					[men, {x:90, y:300, scale:1}],
					[plant1, {x:280, y:415}],
					[plant2, {x:290, y:110, scale:1}],
					[sofa, {x:-280, y:320, scale:1}],
					[book, {x:5, y:5, scale:1}],
					[table, {visible:false}],
					[logo, {x:180, y:35, scale:1}],
					[button_continue, {x:180, y:595, scale:1}],
					[layer.ps, {x:180, y:320}]
				],
				landscape: [
					[back, {x:0, y:0, scale:0.565}],									
					[stair, {x:365, y:-47, scale:0.85}],
					[icons_stair, {x:365, y:-47, scale:0.85}],
					[men, {x:300, y:195, scale:0.65}],
					[plant1, {x:570, y:215}],
					[plant2, {x:535, y:85, scale:0.8}],
					[sofa, {x:6, y:180, scale:0.56}],
					[book, {x:350, y:15, scale:0.7}],
					[table, {visible:true, x:50, y:90}],
					[logo, {x:90, y:35, scale:0.9}],					
					[button_continue, {x:320, y:315, scale:0.8}],
					[layer.ps, {x:320, y:170}]
				]
			});

			function hammerTapHandler() {
				icon_hammer.off('tap', hammerTapHandler);
				icon_hammer.interactive = false;
				gsap.killTweensOf(icon_hammer);
				gsap.to(icon_hammer, {alpha:0, visible:false, duration:0.25});
				for (var i=0; i<icons.length; i++) {
					icons[i].visible = true;
					gsap.to(icons[i], {alpha:1, delay:i*0.125, duration:0.25});					
					gsap.from(icons[i], {x:icons[i].x+200, y:icons[i].y-200, delay:i*0.125, duration:0.5, ease:'back.out'});
				}
			}

			function makeIconStair(name, x, y, bindedStair) {
				var icon = lev.container({x, y, visible:false, alpha:0, add:icons_stair});
				icon.back = lev.sprite('icon_stair_back_off', {interactive:true, add:icon});
				icon.select = lev.sprite('icon_stair_back_on', {visible:false, add:icon});
				lev.sprite(name, {add:icon});
				icon.ok = lev.sprite('button_ok', {anchor:[0.5,0], x:41, y:67, alpha:0, interactive:true, add:icon});
				icons.push(icon);
				icon.back.on('tap', iconTapHandler);
				icon.ok.on('tap', okTapHandler);

				function iconTapHandler() {
					if (icon.select.visible) return;

					for (var i of icons) {
						if (i == icon) continue;						
						gsap.to(i.ok, {alpha:0, duration:0.25});
						i.select.visible = false;
					}					
					icon.select.visible = true;
					gsap.to(icon.ok, {alpha:1, duration:0.25});
					gsap.from(icon.ok, {angle:15, duration:1, ease:'elastic.out'});

					gsap.killTweensOf(currStair);
					gsap.to(currStair, {alpha:0, duration:0.25});
					bindedStair.parent.setChildIndex(bindedStair, bindedStair.parent.children.length-1);		
					gsap.fromTo(bindedStair, {alpha:0}, {alpha:1, y:0, duration:0.25});	
					gsap.fromTo(bindedStair, {y:-25}, {y:0, duration:0.75, ease:'bounce.out'});	
					currStair = bindedStair;
				}

				function okTapHandler() {
					for (var i of icons) {
						i.back.interactive = false;
						i.ok.interactive = false;
					}
					showPackshot();
				}				
			}			

			function showPackshot() {
				layer.ps.alpha = 0;
				lev.shapeRect(0x000000, [-320,-320,640,640], {alpha:0.6, add:layer.ps});	
				var ps = lev.sprite('packshot', {anchor:0.5, add:layer.ps});

				gsap.to(layer.ps, {alpha:1, duration:0.75});			
				gsap.from(ps.scale, {x:0.25, y:0.25, duration:0.75, ease:'back.out'});			

				stage.on('click', adClickHandler);
				stage.on('tap', adClickHandler);
			}	

			function adClickHandler() {
				console.log('adClickHandler');
			}			
		}	
	}
})()
</script>
</head>
<body style="margin:0px;">	
</body>
</html>