<!DOCTYPE html>
<html lang="en">

<head>
    <title>MotoRace</title>

    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport"
        content="initial-scale=1, width=device-width, height=device-height, viewport-fit=cover, user-scalable=no">

    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        canvas {
            display: block;
        }
    </style>
       
    <script src="libs/matter.js"></script>   
</head>

<body>
    <canvas id="game"></canvas>
    <script>
        let bx = 300;
        let by = 700;

        let wxA = bx + 90;
        let wyA = by + 60;

        let wxB = bx + -100;
        let wyB = by + 60;

        let wheelSize = 41;

        let engine = Matter.Engine.create({
            gravity: {x:0, y:1, scale:0.001}
        });

        let group = Matter.Body.nextGroup(true);

        let moto = Matter.Composite.create({ label: 'Moto' });

        let body = Matter.Bodies.rectangle(bx, by, 140, 100, {
            collisionFilter: {
                group: group
            },
            chamfer: {
                radius: 60
            },
            mass: 1,
            density: 0.0002,
            frictionAir: 0.02
        });        

        let wheelA = Matter.Bodies.circle(wxA, wyA, wheelSize, {
            collisionFilter: {
                group: group
            },
            mass: .1,
            friction: 0.9,           
            frictionAir: 0.01
        });

        let wheelB = Matter.Bodies.circle(wxB, wyB, wheelSize, {
            collisionFilter: {
                group: group
            },
            mass: .1,
            friction: 0.9,           
            frictionAir: 0.01
        });

        Matter.Body.setInertia(wheelA, 2000);
        Matter.Body.setInertia(wheelB, 5000);

        let axelA1 = Matter.Constraint.create({
            bodyA: wheelA,
            bodyB: body,
            pointB: { x: 40, y: 0 },
            stiffness: 0.1,
            damping: 0.5    
        });

        let axelA2 = Matter.Constraint.create({
            bodyA: wheelA,
            bodyB: body,
            pointB: { x: 0, y: 60 },
            stiffness: 1           
        });

        let axelB1 = Matter.Constraint.create({
            bodyA: wheelB,
            bodyB: body,
            pointB: { x: -40, y: 20 },
            stiffness: 1
        });

        let axelB2 = Matter.Constraint.create({
            bodyA: wheelB,
            bodyB: body,
            pointB: { x: -100, y: 0 },
            stiffness: 0.1,
            damping: 0.5
        });        

        let ground = Matter.Composite.create({ label: 'Ground' });
        let parts = [];
        let x = 0;
        let y = 1150;
        let length = 100;
        let r = 0.1;
        let angle = 0;
        let aSpeed = 0;

        for (let i = 0; i < 500; i++) {
            aSpeed += -0.005 + Math.random() * 0.01;
            angle += aSpeed;            

            x += length * Math.cos(angle);
            y += length * Math.sin(angle);

            let part = Matter.Bodies.rectangle(x, y, length * 2, 60, { isStatic: true, friction: 1 });
            Matter.Body.setAngle(part, angle);
            parts.push(part);

            x += length * Math.cos(angle);
            y += length * Math.sin(angle);
        }        

        Matter.Composite.add(ground, parts);          

        Matter.Composite.add(moto, [
            body,            
            wheelA,
            wheelB,
            axelA1,
            axelA2,
            axelB1,
            axelB2            
        ]);

        Matter.Composite.add(engine.world, [moto, ground]);

        let runner = Matter.Runner.create();
        Matter.Runner.run(runner, engine);

        
        var render = Matter.Render.create({
            element: document.body,
            engine: engine,
            options: {
                top: 0,
                width: 800,
                height: 800,
                showAngleIndicator: true,
                //showCollisions: true
            }
        });

        Matter.Render.run(render);        
        Matter.Render.lookAt(render, {
            min: { x: -800, y: 0 },
            max: { x: 800*2, y: 600*2 }
        });

        let keys = {
            up: false,
            down: false,
            left: false,
            right: false,
        }       

        document.addEventListener("keydown", (event) => {
		    if (event.code == "KeyW") keys.up = true;
		    if (event.code == "KeyS") keys.down = true;
		    if (event.code == "KeyA") keys.left = true;
		    if (event.code == "KeyD") keys.right = true;
	    });

        document.addEventListener("keyup", (event) => {
            if (event.code == "KeyW") keys.up = false;
            if (event.code == "KeyS") keys.down = false;
            if (event.code == "KeyA") keys.left = false;
		    if (event.code == "KeyD") keys.right = false;
	    });


        function update() {
            if (keys.up && wheelB.angularVelocity < 0.3) {                
                Matter.Body.setAngularVelocity(wheelB, wheelB.angularVelocity + 0.015);
            }

            if (keys.down && wheelB.angularVelocity > -0.3) {                
                Matter.Body.setAngularVelocity(wheelB, wheelB.angularVelocity - 0.015);
            }

            if (keys.left) {
                Matter.Body.setAngularVelocity(body, body.angularVelocity - 0.0005);
            }

            if (keys.right) {
                Matter.Body.setAngularVelocity(body, body.angularVelocity + 0.0005);
            }

            Matter.Render.lookAt(render, {
                min: { x: body.position.x-600, y: body.position.y-600 },
                max: { x: body.position.x+600*2, y: body.position.y+600 }
            });           

            requestAnimationFrame(() => update());
        }

        update();
    </script>
</body>

</html>