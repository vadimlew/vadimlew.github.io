<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>LIM</title>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r125/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fflate@0.7.1/umd/index.min.js"></script>
<script type="text/javascript" src="FBXLoader.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/5.1.3/pixi.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.5.1/gsap.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.1/howler.min.js"></script>
<script type="text/javascript" src="LEV.js"></script>

<script type="text/javascript">
(function() {
	'use strict'
	window.onload = function init() {		
		var lev = new LEV(640, 1080);		
		document.body.appendChild(lev.app.view);

		var stage = lev.app.stage;
		stage.interactive = true;		
		
		var game = {
			main: lev.container({add:stage}),
			ps: lev.container({add:stage})
		};	
		
		var render3d = new THREE.WebGLRenderer({alpha:true, antialias:true});
		render3d.shadowMap.enabled = true;
    	render3d.shadowMap.type = THREE.PCFSoftShadowMap;    	
		render3d.setSize(540, 540);
		var scene = new THREE.Scene();
		var texture3d = PIXI.Texture.from(render3d.domElement);

		var camera = new THREE.PerspectiveCamera(65, 1);
		camera.position.set(60,100,60);
		//camera.position.set(120,200,120);
		//camera.position.set(20,20,30);
		camera.lookAt(0,0,0);
		scene.add(camera);		

		var point_light = new THREE.PointLight( 0xe0e2aa, 0.8, 0, 2 );
	    point_light.position.set( 100, 250, -100 );
	    point_light.castShadow = true; 
	    point_light.shadow.mapSize.set(1024, 1024);
	    scene.add(point_light);	    

		var abient_light = new THREE.AmbientLight( 0xe0e2aa, 0.8 ); 		
		scene.add(abient_light);	

		var harvester, truck;	
		var trees = [];			
		var trucks = [];

		var globalTL = gsap.timeline({repeat:-1, paused:true});

		loadModels([
			{url:'assets/ground.fbx', cb:onGroundLoad},
			{url:'assets/tree.fbx', cb:onTreeLoad},
			{url:'assets/fir.fbx', cb:onFirLoad},
			{url:'assets/truck.fbx', cb:onTruckLoad},
			{url:'assets/harvester.fbx', cb:onHarvesterLoad}
		], ()=>{
			lev.app.loader
			.add('button', 'assets/button.png')		
			.load(startGame)
			//startGame();
		})

		function loadModels(paths, onLoadComplete) {
			var loaderFBX = new THREE.FBXLoader();
			var i=0;

			loadNext();

			function loadNext() {
				if (i >= paths.length) {
					onLoadComplete();
					return;
				}
				loaderFBX.load(paths[i].url, (obj) => {
					paths[i].cb(obj);
					i++;
					loadNext();
				})
			}			
		}

		function onGroundLoad(obj) {
			let ground = obj.children[0];
			ground.receiveShadow = true;
			scene.add(ground);
		}

		function onTreeLoad(obj) {			
			obj.children[0].castShadow = true;

			for (let i=0; i < 10; i++) {
				for (let j=0; j < 4; j++) {
					let tree = obj.clone();
					tree.position.x = 28 + j*11;
					tree.position.z = -150 + i*22 - 11*(j%2);					
					tree.rotation.y = 2*Math.PI*Math.random();
					tree.maxZ = 70;
					tree.deltaZ = 220;
					var scale = 0.8+0.2*Math.random();
					tree.scale.set(scale, scale, scale);
					trees.push(tree);
					scene.add(tree);					
				}
			}
		}

		function onFirLoad(obj) {
			let Fir = obj;			
			Fir.children[0].castShadow = true; 	 	
			Fir.children[1].castShadow = true;

			let dx = 9.5;
			let dz = 10;

			for (let i=0; i < 29; i++) {
				for (let j=0; j < 8; j++) {
					let fir = Fir.clone();
					fir.position.x = -52.5 - j*dx;
					fir.position.z = 65 - i*dz;
					fir.maxZ = 65;
					fir.deltaZ = 180+100;					
					scene.add(fir);
					globalTL.to(fir.position, {z:'+=10', duration:1, ease:'none', repeat:-1}, 0);
				}
			}

			var cutTL = gsap.timeline({repeat:-1, duration:1});

			for (let i=0; i < 17; i++) {
				for (let j=0; j < 5; j++) {
					let fir = Fir.clone();
					fir.position.x = -5 - j*dx;
					fir.position.z = -5 - i*dz;
					fir.maxZ = -7;
					fir.deltaZ = 170;
					fir.name = 'fir';

					if (i == 0) {	
						cutTL.call(()=>{fir.getObjectByName('foliage').visible = true;});						
						cutTL.to(fir.position, {x:5.25+j*1.4, y:3.8, duration:0.6, ease:'quad.inOut'}, j*0.05);
						cutTL.to(fir.rotation, {x:-1.57, duration:0.6, ease:'quad.inOut'}, j*0.05);
						cutTL.call(()=>{							
							fir.getObjectByName('foliage').visible = false;	
						}, null, j*0.1+0.25);
											
					} else {
						globalTL.to(fir.position, {z:'+=10', duration:1, ease:'none', repeat:-1}, 0);
					}

					scene.add(fir);
				}
			}

			globalTL.add(cutTL, 0);
		}

		function onTruckLoad(obj) {
			let truck = obj;
			for (var child of truck.children) {				
				child.castShadow = true;				
				if (child.name != 'trunk') child.receiveShadow = true;
			}	

			truck.position.set(8,0,-15);			
			scene.add(truck);

			let truck2 = truck.clone();
			truck2.position.set(8,0,10);
			truck2.trunk = truck2.getObjectByName('trunk');			
			truck2.trunk.visible = false;
			scene.add(truck2);

			let truck3 = truck.clone();
			truck3.position.set(8,0,100);
			truck3.trunk = truck3.getObjectByName('trunk');			
			truck3.trunk.visible = false;
			scene.add(truck3);

			var truckTL = gsap.timeline({repeat:-1, duration:1});
			truckTL.to(truck.position, {z:-180, duration:1, ease:'quad.in'}, 0);
			truckTL.to(truck2.position, {z:-15, duration:0.5, ease:'quad.inOut'}, 0);
			truckTL.to(truck3.position, {z:10, duration:1, ease:'quad.inOut'}, 0);

			globalTL.add(truckTL, 0);			
		}

		function onHarvesterLoad(obj) {
			harvester = obj;
			for (var child of harvester.children) {
				child.castShadow = true;
				child.receiveShadow = true;
			}	

			harvester.wheels1 = harvester.getObjectByName('wheels1');
			harvester.wheels2 = harvester.getObjectByName('wheels2');
			harvester.stick = harvester.getObjectByName('stick');
			harvester.saw = harvester.getObjectByName('saw');

			harvester.stick.position.x = 18;	
			harvester.saw.position.x = 18;	

			harvester.position.set(-23,0,17);
			scene.add(harvester);		

			var tl = gsap.timeline({repeat: -1, duration:2});
			tl.to(harvester.saw.rotation, {z:3.14*8, duration:2, ease:'linear'}, 0);
			tl.to(harvester.wheels1.rotation, {z:3.14*2, duration:2, ease:'linear'}, 0);
			tl.to(harvester.wheels2.rotation, {z:3.14*2, duration:2, ease:'linear'}, 0);
			tl.to(harvester.stick.position, {x:-20, duration:0.5, ease:'quad.inOut'}, 0.5);
			tl.to(harvester.saw.position, {x:-20, duration:0.5, ease:'quad.inOut'}, 0.5);
			tl.to(harvester.stick.position, {x:18, duration:0.5, ease:'quad.inOut'}, 1.5);
			tl.to(harvester.saw.position, {x:18, duration:0.5, ease:'quad.inOut'}, 1.5);

			globalTL.add(tl, 0);			
		}		
		
		function startGame() {			
			//globalTL.play();			

			lev.sprite(texture3d, {anchor:0.5, scale:2, add:game.main});	
			var button = lev.sprite('button', {anchor:0.5, alpha:0.75, interactive:true, add:game.main});

			button.on('pointerdown', downHandler);	
			button.on('pointerup', upHandler);	
			
			lev.resize.start({
				portrait: [
					[game.main, {x:320, y:540}],
					[button, {x:0, y:470}],
					[game.ps, {x:320, y:540}],
					[camera, {x:320, y:540}]
				],
				landscape: [
					[game.main, {x:540, y:320}],
					[button, {x:0, y:250}],
					[game.ps, {x:540, y:320}],
					[camera, {x:540, y:320}]
				]
			});

			function downHandler() {				
				globalTL.play();
			}

			function upHandler() {				
				globalTL.pause();		
			}

			function animate() {
				for (let tree of trees) {
					if (!globalTL.paused()) tree.position.z += 2/30;
					if (tree.position.z >= tree.maxZ) {						
						tree.position.z -= tree.deltaZ;						
					}
				}

				render3d.render(scene, camera);	
				texture3d.update();				
				requestAnimationFrame(animate);
			}
			animate();		    	
		}
		
		function showPackshot() {
			stage.on('click', adClickHandler);
			stage.on('tap', adClickHandler);			
		}		

		function adClickHandler() {
			
		}
	}
})()
</script>
</head>
<body style="margin:0px;">	
</body>
</html>