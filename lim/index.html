<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>LIM</title>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r125/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fflate@0.7.1/umd/index.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r132/examples/js/loaders/FBXLoader.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/5.1.3/pixi.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.5.1/gsap.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.1/howler.min.js"></script>
<script type="text/javascript" src="LEV.js"></script>

<script type="text/javascript">
(function() {
	'use strict'
	window.onload = function init() {		
		var lev = new LEV(640, 1080);		
		document.body.appendChild(lev.app.view);

		var stage = lev.app.stage;
		stage.interactive = true;		
		
		var game = {
			main: lev.container({add:stage}),
			ps: lev.container({add:stage})
		};	
		
		var render3d = new THREE.WebGLRenderer({alpha:true, antialias:true});
		render3d.shadowMap.enabled = true;
    	render3d.shadowMap.type = THREE.PCFSoftShadowMap;    	
		render3d.setSize(1080, 1080);
		var scene = new THREE.Scene();
		var texture3d = PIXI.Texture.from(render3d.domElement);

		var camera = new THREE.PerspectiveCamera(65, 1);
		camera.position.set(60,80,60);
		camera.lookAt(0,0,0);
		scene.add(camera);		

		var point_light = new THREE.PointLight( 0xe0e2aa, 0.8, 0, 2 );
	    point_light.position.set( 100, 250, -100 );
	    point_light.castShadow = true; 
	    point_light.shadow.mapSize.set(2048, 2048);
	    scene.add(point_light);	    

		var abient_light = new THREE.AmbientLight( 0xe0e2aa, 0.8 ); 		
		scene.add(abient_light);

		//scene.fog = new THREE.Fog(0x649745, 100, 400);	

		var trees = new THREE.Object3D();
		scene.add(trees);
		var truck;	

		var loaderFBX = new THREE.FBXLoader();

		loaderFBX.load('assets/ground.fbx', function (object) {	
			let ground = object.children[0];			
			ground.receiveShadow = true;
			scene.add(ground);		
		});	

		loaderFBX.load('assets/tree.fbx', function (object) {	
			let fir = object.children[0];			
			fir.castShadow = true; 
			//fir.receiveShadow = true;

			for (let i=0; i < 28; i++) {
				for (let j=0; j < 10; j++) {
					let clonedFir = fir.clone();
					clonedFir.position.x = -5 - j*9;
					clonedFir.position.z = -5 - i*10;
					trees.add(clonedFir);
				}
			}
					
		});		

		loaderFBX.load('assets/truck.fbx', function (object) {	
			truck = object;		
			for (var child of truck.children) {
				child.castShadow = true;
				child.receiveShadow = true;
			}			
			truck.position.set(8,0,0);
			scene.add(truck);

			startGame();		
		});

		loaderFBX.load('assets/tree2.fbx', function (object) {	
			let tree = object;		
			tree.children[0].castShadow = true;
			//tree.children[0].receiveShadow = true;

			for (let i=0; i < 15; i++) {
				for (let j=0; j < 5; j++) {
					let cloned = tree.clone();
					cloned.position.x = 28 + j*10;
					cloned.position.z = -250 + i*22 - 11*(j%2);					
					cloned.rotation.y = 2*Math.PI*Math.random();
					var scale = 0.8+0.2*Math.random();
					cloned.scale.set(scale, scale, scale);
					trees.add(cloned);
				}
			}	
		});		

		//lev.app.loader		
		//.load(startGame)

		//startGame();
		
		function startGame() {	
			//console.clear();			
			lev.sprite(texture3d, {anchor:0.5, add:game.main});

			//var tl = gsap.timeline({repeat: -1, repeatDelay:1});
			//tl.fromTo(truck.position, {z:0}, {z:-180, duration:2, ease:'quad.inOut'});
			//tl.fromTo(truck.position, {z:100}, {z:0, duration:2, ease:'quad.inOut'});
			
			lev.resize.start({
				portrait: [
					[game.main, {x:320, y:540}],
					[game.ps, {x:320, y:540}],
					[camera, {x:320, y:540}]
				],
				landscape: [
					[game.main, {x:540, y:320}],
					[game.ps, {x:540, y:320}],
					[camera, {x:540, y:320}]
				]
			});

			function animate() {				
				texture3d.update();
				render3d.render(scene, camera);	
				trees.position.z += 0.1;			
				requestAnimationFrame(animate);
			}
			animate();			
		}
		
		function showPackshot() {
			stage.on('click', adClickHandler);
			stage.on('tap', adClickHandler);			
		}		

		function adClickHandler() {
			
		}
	}
})()
</script>
</head>
<body style="margin:0px;">	
</body>
</html>