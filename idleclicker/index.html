<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>IdleClicker</title>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r125/three.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/zlibjs@0.3.1/bin/zlib.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r117/examples/js/loaders/FBXLoader.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/5.1.3/pixi.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.5.1/gsap.min.js"></script>
<script type="text/javascript" src="Ammo.js"></script>
<script type="text/javascript" src="AmmoPhysics.js"></script>
<script type="text/javascript" src="LEV.js"></script>

<script type="text/javascript">
(function() {
	'use strict'
	window.onload = async function init() {		
		var lev = new LEV(640, 960, 0x292929);		
		document.body.appendChild(lev.app.view);

		var stage = lev.app.stage;
		stage.interactive = true;			
		
		var game = {
			main: lev.container({add:stage}),
			ps: lev.container({add:stage})
		};		

		var render3d = new THREE.WebGLRenderer({alpha:true, antialias:true, shadowMapEnabled:true});
		render3d.setSize(960, 960);
		var scene3D = new THREE.Scene();
		var texture3d = PIXI.Texture.from(render3d.domElement);

		var camera = new THREE.PerspectiveCamera(60, 960/960, 1, 1000);		
		camera.position.x = 12;	
		camera.position.y = 5;		
		camera.lookAt(0,0,0);	

		var ambient_light = new THREE.AmbientLight( 0xc0c0c0 ); 
		var direct_light = new THREE.DirectionalLight( 0xffffff, 0.3 );
		direct_light.castShadow = true;
		direct_light.position.x = 10;
		direct_light.position.y = 10;
		direct_light.position.z = -10;
		scene3D.add(ambient_light, direct_light);		

		var pipe = await load3dObject('assets/pipes.fbx');
		var pipeMat = new THREE.MeshStandardMaterial({color: 0x30ad47});
		pipe.castShadow = true;
		pipe.receiveShadow = true;
		for (let child of pipe.children) {				
			child.material = pipeMat;
		}

		var Coin = (await load3dObject('assets/coin.fbx')).children[0];		
		var button = await load3dObject('assets/button.fbx');	
		button.children[0].material = new THREE.MeshStandardMaterial();
		button.children[1].material = new THREE.MeshStandardMaterial({color: 0x524E51});
		button.position.x = 9;
		button.position.y = 1;

		button.children[0].material.map = new THREE.TextureLoader().load( "assets/button.png" );

		var physics = await AmmoPhysics();

		//startGame();	
		
		lev.app.loader
		.add('hand', 'assets/hand.png')		
		.add('logo', 'assets/logo.png')		
		.add('next level', 'assets/next level.png')		
		.add('earned', 'assets/earned.png')		
		.load(startGame)	
		
		function startGame() {	
			var counter = 0;
			var maxCounter = 15;
			var sprite3d = lev.sprite(texture3d, {anchor:0.5, add:game.main});	

			var progressBar = lev.container({pivot:[270,20], add:game.main});
			var pBack = new PIXI.Graphics().beginFill(0x292929).drawRoundedRect(0,0,540,40,16);
			progressBar.addChild(pBack);			
			var pStrip = new PIXI.Graphics().lineStyle(4, 0xffffff).beginFill(0x669c34).drawRoundedRect(0,0,540,40,16);
			progressBar.addChild(pStrip);
			var frame = new PIXI.Graphics().lineStyle(4, 0xffffff).drawRoundedRect(0,0,540,40,16);
			progressBar.addChild(frame);
			pStrip.x = -530;
			pStrip.mask = pBack;

			scene3D.add(pipe);					
			scene3D.add(button);			
			var pushBtn2d = lev.container({interactive:true, add:game.main});
			pushBtn2d.hitArea = new PIXI.Rectangle(-100, -100, 200, 200);
			var g = lev.shapeRect(0x0000aa, [-100,-100,200,200], {alpha:0, add:pushBtn2d});
			pushBtn2d.on('tap', onPushButton);
			pushBtn2d.on('click', onPushButton);

			var floor = new THREE.Mesh(
				new THREE.BoxGeometry( 30, 1, 30 ),
				new THREE.MeshStandardMaterial( { color: 0x292929 } )
			);
			floor.position.y = -3;
			//floor.receiveShadow = true;
			scene3D.add( floor );
			physics.addMesh( floor );

			var pipeBound = new THREE.Mesh(
				new THREE.BoxGeometry( 2.2, 3.6, 2.2 ),
				new THREE.MeshStandardMaterial( { color: 0x000029 } )
			);
			pipeBound.position.y = -0.75;
			//scene3D.add( pipeBound );
			physics.addMesh( pipeBound );	
			
			var pipeHeadBound = new THREE.Mesh(
				new THREE.SphereGeometry( 1.2, 8, 8),
				new THREE.MeshStandardMaterial( { color: 0x000029 } )
			);
			pipeHeadBound.position.y = 0.25;
			//scene3D.add( pipeHeadBound );
			physics.addMesh( pipeHeadBound );

			function onPushButton() {
				button.children[0].position.y -= 0.1;
				gsap.fromTo(button.children[0].position, {y:0.74}, {y:0.6, yoyo:true, repeat:1, duration:0.1, ease:'cubic.out'});
				sprayCoins();
				setProgressBar();
				if (counter == maxCounter) {
					gsap.to(progressBar, {delay:1, alpha:0, duration:0.5});
					pushBtn2d.off('tap', onPushButton);
					pushBtn2d.off('click', onPushButton);
					gsap.delayedCall(1, showPackshot);
				}
			}

			//gsap.delayedCall(1, showPackshot);

			function sprayCoins() {
				for (let i=0; i<6; i++) {
					var coin = Coin.clone();
					coin.scale.set(0.7,0.7,0.7);
					coin.position.x = -0.5 + 1*Math.random();
					coin.position.y = 0.5+Math.random();
					coin.position.z = -0.5 + 1*Math.random();
					coin.rotation.x = Math.random();
					coin.rotation.y = Math.random();
					coin.rotation.z = Math.random();					
					scene3D.add(coin);	
					physics.addMesh( coin, 1 );
					physics.setMeshVelocity( coin, -2 + 4*Math.random(), 5 + 5*Math.random(), -2 + 4*Math.random() );
				}
				counter++;
			}

			function testCoins() {
				for (let i=0; i<3; i++) {
					var coin = Coin.clone();
					coin.scale.set(0.7,0.7,0.7);
					coin.position.x = 100;		
					coin.position.y = 0.5+Math.random();							
					scene3D.add(coin);	
					physics.addMesh( coin, 1 );
					physics.setMeshVelocity( coin, 1, 1 , 1 );
				}
			}

			function setProgressBar() {				
				gsap.killTweensOf(pStrip);
				let x = Math.min(-540+counter*(540/maxCounter), 0);
				gsap.to(pStrip, {x, duration:1, ease:'sine.out'});
			}

			testCoins();		
			
			lev.resize.start({
				portrait: [
					[game.main, {x:320, y:480}],
					[pushBtn2d, {y:340}],
					[progressBar, {y:-400}],
					[game.ps, {x:320, y:480}],
					[camera.position, {x:12, y:5}]
				],
				landscape: [
					[game.main, {x:480, y:320}],
					[pushBtn2d, {y:280}],
					[progressBar, {y:-240}],
					[game.ps, {x:480, y:320}],
					[camera.position, {x:14, y:6}]			
				]
			});

			function animate() {
				physics.step();			
				texture3d.update();
				render3d.render(scene3D, camera);				
				requestAnimationFrame(animate);
			}
			animate();			
		}			

		function showPackshot() {
			var solid = lev.shapeRect(0x000000, [-480,-480,960,960], {alpha:0, add:game.ps});
			var logo = lev.sprite('logo', {anchor:0.5, scale:0, add:game.ps});
			var nextLevel = lev.sprite('next level', {anchor:0.5, scale:0, add:game.ps});
			var youEarned = lev.container({add:game.ps});
			var earned = lev.sprite('earned', {anchor:0.5, scale:0, add:youEarned});
			lev.text(parseInt(5000 + 5000*Math.random())+'$', {anchor:0.5, y:30, add:earned}).style = {fill:0xff2c2d, fontFamily:'Fredoka One', fontSize:60};

			gsap.to(solid, {alpha:0.6, duration:0.5});
			gsap.to(logo.scale, {x:1, y:1, ease:'back.out', duration:0.5});			
			gsap.to(earned.scale, {x:1, y:1, delay:0.1, ease:'back.out', duration:0.5});
			gsap.to(nextLevel.scale, {x:1, y:1, delay:0.2, ease:'back.out', duration:0.5});
			gsap.to(nextLevel.scale, {x:0.9, y:0.9, delay:0.7, duration:1, repeat:-1, yoyo:true, ease:'quad.inOut'});

			lev.resize.add(logo, {y:-320}, {y:-190});
			lev.resize.add(youEarned, {y:40, scale:1}, {y:45, scale:0.7});
			lev.resize.add(nextLevel, {y:360}, {y:230});

			stage.on('click', adClickHandler);
			stage.on('tap', adClickHandler);			
		}		

		function adClickHandler() {
			
		}

		function load3dObject(url) {
			return new Promise((resolve, reject) => {
				let loaderFBX = new THREE.FBXLoader();
				loaderFBX.load(url, resolve, null, reject);
			});			
		}
	}
})()
</script>
</head>
<body style="margin:0px;">	
</body>
</html>