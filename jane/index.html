<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Jane</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/5.1.3/pixi.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.8.0/gsap.min.js"></script>

<script type="text/javascript">
 window.onload = function init() {
  const app = new PIXI.Application({
    width: 700, 
    height: 700,     
    transparent: true,
    antialias: true     
  }); 
  document.body.appendChild(app.view);
  const stage = app.stage; 

  let baseTexture = new PIXI.BaseTexture('jane.png');

  baseTexture.on('loaded', ()=>{
    let logoTexture = new PIXI.Texture(baseTexture);
    let logoMesh = mesh(logoTexture, 5, 5, false);  
    stage.addChild(logoMesh);    

    setTimeout(()=>{     
      animateColumn(logoMesh, 0, 3, 40, -40, 3.5);   
      animateColumn(logoMesh, 1, 3, 40, 40, 3.3);  
      animateColumn(logoMesh, 2, 3, 40, -40, 3.1);
    }, 10); 

    let star1 = PIXI.Sprite.from('star1.png');
    star1.anchor.set(0.5);
    star1.position.set(87, 50);
    let star2 = PIXI.Sprite.from('star2.png');
    star2.anchor.set(0.5);
    star2.position.set(25, 25);

    stage.addChild(star1, star2);

    gsap.from(star1.scale, {x:0.3, y:0.3, duration:2, yoyo:true, repeat:-1, ease:'quad.inOut'});
    gsap.from(star2.scale, {x:0.3, y:0.3, duration:3, yoyo:true, repeat:-1, ease:'quad.inOut'});
  })   

  function animateColumn(logoMesh, strtIdx, delta, rangeX, rangeY, duration) {    
    let tweenData = '';

    let len = logoMesh.vertexData.length/2;
    for(let i=strtIdx; i<len; i+=delta) {    
      let dx = parseInt(-rangeX/2+rangeX*Math.random());
      let dy = parseInt(-rangeY/2+rangeY*Math.random()); 
      logoMesh.vertexData[i*2] -= dx;   
      logoMesh.vertexData[i*2+1] -= dy;      
      tweenData = tweenData.concat(i+'/x'+dx*2+'/y'+dy*2+',');
    }  

    createLoopAnimateMesh(logoMesh, tweenData, duration);
  }  

  function mesh(texture, row, col, debug=false) {
    if (typeof(texture) == 'string') texture = app.loader.resources[texture].texture;     
    var mesh = new PIXI.SimplePlane(texture, row, col);    
    mesh.calculateVertices();
    mesh.calculateUvs();

    if (debug) {        
      var marks = new PIXI.Graphics();        
      stage.addChild(marks);

      app.ticker.add(() => {
        marks.clear();
        marks.beginFill(0x00ffff);
        for (let i=0; i<mesh.vertexData.length; i+=2) {
          var x = mesh.vertexData[i]/stage.scale.x;
          var y = mesh.vertexData[i+1]/stage.scale.y;
          marks.drawRect(x-4, y-0.5, 9, 2);
          marks.drawRect(x-0.5, y-4, 2, 9);
        }
        marks.endFill();
      });
    }

    return mesh;
  }

  function createLoopAnimateMesh(mesh, data, timeOrTween, delay=0) {
    var points = []; 
    var displacies = []; 

    for (var point of data.split(',')) {
      var parse = point.split('/');
      var ids = parse[0];       
      var dx = parse[1]? Number(parse[1].match(/-*\d+/)[0]) : 0;
      var dy = parse[2]? Number(parse[2].match(/-*\d+/)[0]) : 0;

      if (ids.includes('all')) {
        var len = mesh.vertexData.length/2;
        points.push(...Array(len).fill().map((el, i)=>{return i}));
        displacies.push(...Array(len).fill([dx,dy]));
      } else if (ids.includes('_')) {
        ids = ids.split('_').map(Number); 
        var len = ids[1]-ids[0]+1;          
        points.push(...Array(len).fill().map((el,i)=>{return ids[0]+i}));
        displacies.push(...Array(len).fill([dx,dy]));
      } else if (ids.includes(' ')) {
        ids = ids.match(/\d+/g).map(Number);
        points.push(...ids);
        displacies.push(...Array(ids.length).fill([dx,dy]));          
      } else {          
        points.push(Number(ids));
        displacies.push([dx,dy]);         
      }
    }

    var prop = {m:0};
    var prevD = prop.m;      
    var tween_prop = {m:1, repeat:-1, yoyo:true, ease:'sine.inOut', onUpdate, delay};
    if (typeof(timeOrTween) == 'object') {
      Object.assign(tween_prop, timeOrTween);
    } else {
      tween_prop.duration = timeOrTween;
    }
    gsap.to(prop, tween_prop);
    function onUpdate() {
      var n = prop.m - prevD;
      prevD = prop.m;
      for (let i = 0; i < points.length; i++) {
        var ix = points[i]*2;
        var iy = points[i]*2+1;
        mesh.vertexData[ix] += displacies[i][0]*n;
        mesh.vertexData[iy] += displacies[i][1]*n;
      }
    }           
  } 

 }
</script>

</head>
<body style="margin:0px; background-color: black;"> 
</body>
</html>