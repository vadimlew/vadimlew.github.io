<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>fortunecircle</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/5.1.3/pixi.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.5.1/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.1/howler.min.js"></script>

<script type="text/javascript">
(function() {
	'use strict'
	window.onload = function init() {		
		PIXI.settings.TARGET_FPMS = 0.025;	

		const app_width = 640;
		const app_height = 1080;
		const app = new PIXI.Application({
			width: app_width, 
			height: app_height, 
			backgroundColor: 0x000000,	
			antialias: true
			//resolution: window.devicePixelRatio || 1
		});		
		
		document.body.appendChild(app.view);
		app.view.style.position = 'absolute';
		app.view.style.display = 'block';
		app.view.style.top = "50%";
		app.view.style.left = "50%";
		app.view.style.transform = "translate(-50%, -50%)";	

		app.loader
		.add('bg', 'image/bg.jpg')
		.add('chest', 'image/chest.png')
		.add('circle_static', 'image/circle_static.png')
		.add('circle', 'image/circle.png')
		.add('pin', 'image/pin.png')
		.add('go', 'image/go.png')
		.add('fire', 'image/fire.png')
		.add('blast', 'image/blast.png')
		.add('download', 'image/download.png')
		.add('arrow', 'image/arrow.png')
		.add('almaz', 'image/almaz.png')		
		.add('ring1', 'image/ring1.png')
		.add('ring2', 'image/ring2.png')
		.add('500', 'image/500.png')
		.add('800', 'image/800.png')
		.add('1100', 'image/1100.png')
		.add('hand', 'image/hand.png')
		.load(startGame)

		var stage = app.stage;
		stage.interactive = true;		
		var game = {};	
		var almaz_count = 0;		
		
		/*var sound = new Howl({
		    src: ["image/music.mp3"],
		    autoplay: true,
		    loop: true
		});	*/		

		function startGame() {
			var bg = createSprite('bg', {anchor:0.5, add:stage});
			var circ_cnt = createSprite({add:stage});
			var fire = createAnimSprite('fire', {row:3, col:4, w:510, h:510, len:11}, {anchor:0.5, scale:1.7, loop:true, animationSpeed:0.75, add:circ_cnt}); fire.play();
			
			var circle_static = createSprite('circle_static', {anchor:[0.5,0.51], add:circ_cnt});
			var circle_rolling = createSprite('circle', {anchor:[0.5,0.51], alpha:0, add:circle_static});

			var pin = createSprite('pin', {anchor:0.5, interactive:true, add:circ_cnt});
			var go = createSprite('go', {anchor:0.5, add:circ_cnt});
			var hand = createSprite('hand', {x:-17, add:go});
			gsap.to(hand.scale, {x:0.75, y:0.75, duration:0.75, yoyo:true, repeat:-1, ease:'quad.inOut'});
			createSprite('arrow', {anchor:0.5, y:-180, scale:0.25, add:circ_cnt});	

			var chest_cnt = createSprite({add:stage});
			var chest1 = createSprite('chest', {anchor:0.5, add:chest_cnt});
			var chest2 = createSprite('chest', {anchor:0.5, x:-350, add:chest_cnt});
			var chest3 = createSprite('chest', {anchor:0.5, x:350, add:chest_cnt});
			
			shake(chest1);
			shake(chest2, chest2.x);
			shake(chest3, chest3.x);

			var almaz1 = createSprite('almaz', {anchor:0.5, scale:0.9, alpha:0, add:chest_cnt});
			createSprite('500', {anchor:0.5, y:30, add:almaz1});
			var almaz2 = createSprite('almaz', {anchor:0.5, scale:0.9, alpha:0, x:-350, add:chest_cnt});
			createSprite('800', {anchor:0.5, y:30, add:almaz2});
			var almaz3 = createSprite('almaz', {anchor:0.5, scale:0.9, alpha:0, x:350, add:chest_cnt});
			createSprite('1100', {anchor:0.5, y:30, add:almaz3});
			var almazes = [almaz2, almaz1, almaz3];

			var gem1 = createSprite({add:stage});
			var gem2 = createSprite({add:stage});
			var ring1 = createSprite('ring1', {anchor:0.5, add:gem1});
			var ring2 = createSprite('ring2', {anchor:0.5, add:gem2});

			gsap.to(ring1, {y:-20, duration:3, delay:1, yoyo:true, repeat:-1, ease:'quad.inOut'});
			gsap.to(ring2, {y:-20, duration:3, yoyo:true, repeat:-1, ease:'quad.inOut'});

			var blast = createAnimSprite('blast', {row:4,col:4,w:512,h:512}, {anchor:0.5, loop:false, visible:false, add:chest1});

			function shake(sprite, x=0, y=0, duration=0.25+0.25*Math.random()) {
				var rand1 = Math.random();
				var rand2 = Math.random();
				gsap.to(sprite, {x:x-10+20*rand1, y:y+10-20*rand2, duration, ease:'linear', onComplete:shake, onCompleteParams:[sprite, x, y, duration]});
			}

			pin.on('tap', startRotation);
			pin.on('click', startRotation);
			function startRotation() {
				if (go.alpha != 1) return;
				gsap.to(go, {alpha:0, duration:0.25});				
				circle_static.angle = 0;
				circle_rolling.alpha = 0;
				gsap.to(circle_static, {angle:3600, duration:2, ease:'quad.inOut', onComplete:()=>{
					showAlmaz(almaz1);
				}});
				gsap.to(circle_rolling, {alpha:1, duration:1});
				gsap.to(circle_rolling, {alpha:0, delay:1.5, duration:1});				
			}

			function showAlmaz() {
				var almaz = almazes[almaz_count];
				blast.gotoAndPlay(0);
				blast.x = almaz.x;
				blast.visible = true;
				blast.onComplete = function() {					
					blast.visible = false;
					almaz_count++;
				}
				gsap.to(almaz, {alpha:1, duration:0.5, ease:'linear'});
				gsap.to(almaz, {alpha:0, delay:2, duration:0.5, ease:'linear', onComplete:()=>{					
					if (almaz_count >= 3) {
						showPackshot();
					} else {
						gsap.to(go, {alpha:1, duration:0.25});
					}
				}});
			}

			function showPackshot() {
				gsap.to(circ_cnt, {alpha:0, duration:0.5});
				gsap.to(chest_cnt, {alpha:0, duration:0.5});
				gsap.to(gem1, {alpha:0, duration:0.5});
				gsap.to(gem2, {alpha:0, duration:0.5});

				var download = createSprite('download', {anchor:0.5, scale:0.25, alpha:0, add:bg});
				gsap.to(download, {alpha:1, duration:1});
				gsap.to(download.scale, {x:1, y:1, duration:1, ease:'quad.out'});

				gsap.to(download.scale, {x:0.9, y:0.9, delay:1, yoyo:true, repeat:-1, duration:1, ease:'quad.inOut'});
						
				stage.on('click', adClickHandler);	
				stage.on('tap', adClickHandler);
			}	

			var resObj = {
				portrait: [
					[bg,320,540],
					[circ_cnt,320,520],
					[gem1,120,160,0.9],
					[gem2,520,160,0.9],
					[chest_cnt,320,930,0.6]
				],
				landscape: [
					[bg,540,320],
					[circ_cnt,540,200],
					[gem1,150,195,1],
					[gem2,930,195,1],
					[chest_cnt,540,510,0.9]
				]
			}
			startResize(resObj);
		}			

		function adClickHandler() {
			
		}

		function createSprite(texture_name, transform) {
			if (arguments.length == 1 && typeof(arguments[0]) == 'object') {
				transform = arguments[0];
				var sprite = new PIXI.Container();
			} else {
				var texture = app.loader.resources[texture_name].texture;
				var sprite = new PIXI.Sprite(texture);
			}
			if (transform) setTransform(sprite, transform);
			return sprite;
		}	

		function createAnimSprite(texture_name, anim_data, transform) {
			var sprite;
			var texture = app.loader.resources[texture_name].texture.baseTexture;
			
			if (anim_data.hasOwnProperty('row')) {
				var data = anim_data;
				anim_data = {frames:{}, animations:{anim:[]}, meta:{scale:1}};
				var len = data.len? data.len : data.row * data.col;
				var w = data.w;
				var h = data.h;
				for (let i=0; i < len; i++) {
					let name = texture_name + '_frame' + i;				
					let x = w*(i%data.col);
					let y = h*parseInt(i/data.col);
					anim_data.frames[name] = {frame:{x,y,w,h}, sourceSize:{w,h}};
					anim_data.animations.anim.push(name);
				}
			}
			
			var sprite_sheet = new PIXI.Spritesheet(texture, anim_data);
			sprite_sheet.parse(()=>{sprite = new PIXI.AnimatedSprite(sprite_sheet.animations['anim']);});
			if (transform) setTransform(sprite, transform);
			
			sprite.clone = function() {
				var clone = new PIXI.AnimatedSprite(sprite_sheet.animations['anim']);
				if (transform) setTransform(clone, transform);
				return clone;
			}

			return sprite;
		}		

		function setTransform(sprite, transform) {
			for (var prop in transform) {
				if (sprite[prop] === void 0) continue;
				if (typeof transform[prop] == 'number' || typeof transform[prop] == 'boolean') sprite[prop] = transform[prop];
				if (sprite[prop] instanceof PIXI.ObservablePoint) {
					if (typeof transform[prop] === 'number') sprite[prop].set(transform[prop]);
					else if (transform[prop] instanceof Array) sprite[prop].set(...transform[prop]);						
					else if (transform[prop] instanceof (PIXI.ObservablePoint, PIXI.Point)) sprite[prop].copyFrom(transform[prop]);
				}
			}
			if (transform.add) transform.add.addChild(sprite);
		}

		function startResize(resObj) {
			window.addEventListener('resize', resizeHandler);
			resizeHandler();
			function resizeHandler() {
				var iw = window.innerWidth, ih=window.innerHeight;
				if (iw < ih) {	           
		        	var w = app_width, h = app_height; 
		        	setOrientation('portrait');   	        
		        } else {
		        	var h = app_width, w = app_height;
		        	setOrientation('landscape');   
		        }
				var xRatio=iw/w, yRatio=ih/h, sRatio=1;
				sRatio = Math.min(xRatio, yRatio);				
				stage.scale.set(sRatio);
				app.renderer.resize(w*sRatio,h*sRatio);
			}

			function setOrientation(orient) {
				for (var item of resObj[orient]) {					
					item[0].position.set(item[1],item[2]);
					if (item[3]) item[0].scale.set(item[3]);
				}
			}
		}	
	}
})()
</script>
</head>
<body style="margin:0px;">	
</body>
</html>